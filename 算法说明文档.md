# A股股票评分算法详细说明文档

## 一、算法概述
本算法通过综合分析多个技术指标，为A股股票生成买入、持有观望、卖出三种信号，并计算信号强度。算法结合趋势、动量、超买超卖和成交量等多维度因素，提供量化投资参考。

## 二、技术指标评分体系

### 2.1 移动平均线信号（最高+2分，最低-2分）

**买入条件：**
```python
if 当前价格 > MA5 > MA10 > MA20:
    得分 = +2分  # 多头排列，趋势向上
elif 当前价格 > MA5 > MA10:
    得分 = +1分  # 短期多头
```

**卖出条件：**
```python
if 当前价格 < MA5 < MA10 < MA20:
    得分 = -2分  # 空头排列，趋势向下
elif 当前价格 < MA5 < MA10:
    得分 = -1分  # 短期空头
```

**中性条件：**
```python
其他情况:
    得分 = 0分
```

### 2.2 RSI相对强弱指标（最高+3分，最低-3分）

**买入条件：**
```python
if RSI < 30:
    得分 = +3分  # 超卖，强烈买入信号
elif 30 ≤ RSI ≤ 50:
    得分 = +1分  # 低位，有上涨空间
```

**卖出条件：**
```python
if RSI > 70:
    得分 = -3分  # 超买，强烈卖出信号
elif 50 < RSI ≤ 70:
    得分 = -1分  # 高位，卖出信号
```

**背离检测（额外加减分）：**
```python
# 价格创新低，RSI未创新低
if 价格创N日新低 and RSI > 前低RSI:
    额外得分 = +2分  # 底背离

# 价格创新高，RSI未创新高
if 价格创N日新高 and RSI < 前高RSI:
    额外得分 = -2分  # 顶背离
```

### 2.3 MACD指标（最高+3分，最低-3分）

**买入条件：**
```python
if MACD金叉（DIF上穿DEA）:
    得分 += +2分
if MACD柱状图 > 0:
    得分 += +1分  # 多头动能
```

**卖出条件：**
```python
if MACD死叉（DIF下穿DEA）:
    得分 += -2分
if MACD柱状图 < 0:
    得分 += -1分  # 空头动能
```

**零轴突破检测：**
```python
# DIF由下向上突破零轴
if DIF > 0 and 前一日DIF < 0:
    额外得分 = +1分

# DIF由上向下跌破零轴
if DIF < 0 and 前一日DIF > 0:
    额外得分 = -1分
```

### 2.4 布林带信号（最高+2分，最低-2分）

**买入条件：**
```python
# 价格触及或跌破下轨
if 当前价格 ≤ 布林带下轨:
    得分 = +2分  # 超卖反弹机会
```

**卖出条件：**
```python
# 价格触及或突破上轨
if 当前价格 ≥ 布林带上轨:
    得分 = -2分  # 超买回调风险
```

**布林带收口/张口判断：**
```python
# 布林带宽度（带宽） = (上轨 - 下轨) / 中轨
带宽变化率 = (当日带宽 - 前日带宽) / 前日带宽

if 带宽变化率 > 0.1:  # 张口扩大
    if 价格上涨:
        额外得分 = +1分  # 趋势启动
    elif 价格下跌:
        额外得分 = -1分  # 趋势加速

if 带宽变化率 < -0.1:  # 收口
    额外得分 = 0分  # 震荡整理，方向不明
```

### 2.5 成交量信号（最高+1分，最低-1分）

**买入条件：**
```python
# 放量上涨
成交量均量 = MA(成交量, 20)  # 20日平均成交量
if 成交量 > 1.5 × 成交量均量 and 当日涨跌幅 > 0:
    得分 = +1分  # 资金流入
```

**卖出条件：**
```python
# 放量下跌
if 成交量 > 1.5 × 成交量均量 and 当日涨跌幅 < 0:
    得分 = -1分  # 资金流出
```

**量价背离检测：**
```python
# 价格上涨但成交量萎缩
if 当日涨跌幅 > 0 and 成交量 < 0.8 × 成交量均量:
    额外得分 = -1分  # 上涨动能不足

# 价格下跌但成交量萎缩
if 当日涨跌幅 < 0 and 成交量 < 0.7 × 成交量均量:
    额外得分 = +1分  # 抛压减轻
```

### 2.6 A股特色指标（可选，最高±3分）

**北向资金流向：**
```python
# 陆股通净买入占流通市值比例
北向资金占比 = 北向资金净买入额 / 流通市值

if 北向资金占比 > 0.2%:
    得分 = +2分  # 外资大幅流入
elif 北向资金占比 < -0.2%:
    得分 = -2分  # 外资大幅流出
```

**融资融券变化：**
```python
融资余额变化率 = (当日融资余额 - 前日融资余额) / 前日融资余额

if 融资余额变化率 > 0.05:
    得分 = +1分  # 杠杆资金看好
elif 融资余额变化率 < -0.05:
    得分 = -1分  # 杠杆资金撤离
```

**龙虎榜机构净买入：**
```python
if 当日有龙虎榜 and 机构净买入 > 1000万:
    得分 = +2分
elif 当日有龙虎榜 and 机构净卖出 > 1000万:
    得分 = -2分
```

## 三、信号判断逻辑

### 3.1 分数计算汇总
```python
# 初始化分数
买入分数 = 0
卖出分数 = 0

# 累加各指标分数
for 指标 in [均线, RSI, MACD, 布林带, 成交量, ...]:
    指标分数 = 计算指标分数()
    
    if 指标分数 > 0:
        买入分数 += 指标分数
    elif 指标分数 < 0:
        卖出分数 += abs(指标分数)  # 卖出分数取绝对值存储

# 计算理论最大分数（用于归一化）
理论最大买入分数 = 15  # 各指标最高正分之和
理论最大卖出分数 = 15  # 各指标最高负分绝对值之和
```

### 3.2 信号生成规则

**分级阈值系统：**
```python
总分数差值 = 买入分数 - 卖出分数

# 信号分级（可调整阈值）
if 总分数差值 >= 8:
    信号 = "强烈买入"
elif 总分数差值 >= 4:
    信号 = "买入"
elif 总分数差值 >= 2:
    信号 = "谨慎买入"
elif -2 < 总分数差值 < 2:
    信号 = "持有观望"
elif 总分数差值 <= -2:
    信号 = "谨慎卖出"
elif 总分数差值 <= -4:
    信号 = "卖出"
elif 总分数差值 <= -8:
    信号 = "强烈卖出"
```

**多时间框架确认：**
```python
# 日线信号为主，周线信号为辅
日线信号 = 计算日线级别信号()
周线信号 = 计算周线级别信号()

if 日线信号 in ["买入", "强烈买入"]:
    if 周线信号 in ["买入", "强烈买入"]:
        最终信号 = 日线信号  # 多周期共振，信号增强
        置信度乘数 = 1.5
    elif 周线信号 in ["卖出", "强烈卖出"]:
        最终信号 = "持有观望"  # 周期矛盾，观望
        置信度乘数 = 0.5
else:
    最终信号 = 日线信号
    置信度乘数 = 1.0
```

## 四、信号强度计算

### 4.1 基础强度计算
```python
# 避免除零错误
if 买入分数 + 卖出分数 == 0:
    基础强度 = 50  # 中性
else:
    基础强度 = (买入分数 / (买入分数 + 卖出分数)) × 100

# 基础强度反映买入信号在所有信号中的相对强度
# 范围：0-100，50为中性
```

### 4.2 分数因子计算
```python
# 理论最大买入分数为15（根据权重配置调整）
分数因子 = (买入分数 / 理论最大买入分数) × 100

# 分数因子反映买入信号的绝对强度
# 范围：0-100
```

### 4.3 最终强度计算
```python
最终强度 = 基础强度 × 60% + 分数因子 × 40%

# 加入时间衰减因子（信号有效期）
N = 信号生成后的交易日数
衰减因子 = 0.95^N  # 每日衰减5%

最终强度 = 最终强度 × 衰减因子
```

### 4.4 强度等级划分
```python
if 最终强度 >= 80:
    强度等级 = "极强"
elif 最终强度 >= 70:
    强度等级 = "强"
elif 最终强度 >= 60:
    强度等级 = "中等"
elif 最终强度 >= 50:
    强度等级 = "弱"
elif 最终强度 >= 40:
    强度等级 = "很弱"
else:
    强度等级 = "极弱"
```

## 五、风险管理模块

### 5.1 止损位计算
```python
# 动态止损位（基于技术指标）
if 信号 in ["买入", "强烈买入"]:
    止损位1 = min(MA20, 近期低点)  # 移动平均线支撑
    止损位2 = 买入价格 × (1 - 止损比例)  # 固定比例止损
    
    最终止损位 = max(止损位1, 止损位2)  # 取较优的止损位

elif 信号 in ["卖出", "强烈卖出"]:
    # 空头止损位（如果是做空机制）
    止损位 = max(MA20, 近期高点)
```

### 5.2 仓位管理建议
```python
# 基于信号强度和风险调整的仓位计算
基础仓位比例 = 最终强度 / 100  # 0-1之间

# 加入波动率调整
波动率 = 计算ATR(14) / 当前价格
if 波动率 > 0.05:  # 高波动率
    仓位调整系数 = 0.5
elif 波动率 < 0.02:  # 低波动率
    仓位调整系数 = 1.2
else:
    仓位调整系数 = 1.0

# 最终仓位
建议仓位 = min(基础仓位比例 × 仓位调整系数, 最大仓位限制)
```

## 六、算法执行流程

### 6.1 每日数据处理流程
```
1. 数据获取
   ↓
2. 技术指标计算（MA、RSI、MACD、布林带等）
   ↓
3. 各指标独立评分
   ↓
4. 分数汇总（买入分数、卖出分数）
   ↓
5. 信号判断（买入/持有/卖出）
   ↓
6. 信号强度计算
   ↓
7. 风险管理参数计算（止损位、仓位建议）
   ↓
8. 结果输出与记录
```

### 6.2 回测与优化流程
```
1. 历史数据获取（至少3年）
   ↓
2. 参数初始化（权重、阈值）
   ↓
3. 模拟交易（考虑佣金、滑点）
   ↓
4. 绩效评估（夏普比率、最大回撤、胜率等）
   ↓
5. 参数优化（网格搜索或遗传算法）
   ↓
6. 样本外测试验证
   ↓
7. 实盘模拟测试
```

## 七、参数配置表

| 参数类别 | 参数名称 | 默认值 | 可调整范围 | 说明 |
|---------|---------|--------|-----------|------|
| 均线参数 | MA5周期 | 5 | 3-10 | 短期均线 |
| 均线参数 | MA10周期 | 10 | 8-15 | 中期均线 |
| 均线参数 | MA20周期 | 20 | 15-30 | 长期均线 |
| RSI参数 | RSI周期 | 14 | 9-21 | 计算周期 |
| RSI参数 | 超卖阈值 | 30 | 25-35 | 买入信号阈值 |
| RSI参数 | 超买阈值 | 70 | 65-75 | 卖出信号阈值 |
| MACD参数 | 快线周期 | 12 | 8-15 | DIF计算 |
| MACD参数 | 慢线周期 | 26 | 20-30 | DEA计算 |
| MACD参数 | 信号周期 | 9 | 5-12 | MACD信号线 |
| 布林带参数 | 周期 | 20 | 15-25 | 中轨计算 |
| 布林带参数 | 标准差倍数 | 2 | 1.5-2.5 | 上下轨宽度 |
| 成交量参数 | 均量周期 | 20 | 10-30 | 平均成交量计算 |
| 阈值参数 | 买入阈值 | 4 | 3-6 | 生成买入信号 |
| 阈值参数 | 卖出阈值 | -4 | -6到-3 | 生成卖出信号 |
| 强度参数 | 基础强度权重 | 60% | 50%-70% | 信号强度计算 |
| 强度参数 | 分数因子权重 | 40% | 30%-50% | 信号强度计算 |

## 八、注意事项与限制

### 8.1 算法局限性
- **滞后性**：所有技术指标均基于历史数据，具有滞后性
- **市场突变**：重大政策、事件等可能导致算法失效
- **过度拟合风险**：参数优化可能导致历史表现优异但未来失效
- **流动性风险**：小盘股可能出现信号但无法成交

### 8.2 使用建议
- **组合使用**：建议与其他分析方法（基本面、资金面）结合
- **风险控制**：必须设置止损位，控制单笔损失
- **仓位管理**：根据总资金和风险承受能力调整仓位
- **持续监控**：定期回测和优化算法参数
- **市场环境适应**：不同市况（牛、熊、震荡）下调整参数

### 8.3 更新维护
- **月度检查**：检查各指标的有效性
- **季度优化**：根据最新市场数据优化参数
- **年度大修**：全面评估算法绩效，考虑加入新指标

## 九、板块强度计算算法

### 9.1 算法概述
板块强度计算算法用于识别市场中的强势板块，为趋势启动信号扫描提供板块筛选依据。算法综合考虑板块的短期涨幅、中期涨幅、资金流向、成交量变化、长期趋势健康度以及板块逻辑合理性，避免被短期脉冲式反弹误导。

### 9.2 指标权重配置（优化后）

**权重分配原则：**
- 降低短期波动权重，避免单日或几日异常波动影响
- 提高资金流向权重，资金是板块持续走强的核心动力
- 增加长期趋势健康度权重，过滤长期空头趋势板块
- 加入板块逻辑合理性调整，对政策环境不利的板块降权

**具体权重配置：**
```python
# 优化后的权重配置
5日涨幅权重 = 20%      # 原50%，降低短期波动影响
10日涨幅权重 = 15%      # 新增，平滑短期波动
20日涨幅权重 = 25%      # 原30%，略降
资金流向权重 = 30%      # 新增，最高权重
成交量权重 = 10%        # 原20%，降低
趋势健康度权重 = 5分    # 新增，0-5分
基础调整分 = ±3分       # 板块逻辑合理性调整
```

### 9.3 各指标计算方法

#### 9.3.1 涨跌幅指标
```python
# 5日涨跌幅
change_5d = (当前收盘价 / 5日前收盘价 - 1) * 100
score_5d = change_5d * 0.20

# 10日涨跌幅（平滑短期波动）
change_10d = (当前收盘价 / 10日前收盘价 - 1) * 100
score_10d = change_10d * 0.15

# 20日涨跌幅
change_20d = (当前收盘价 / 20日前收盘价 - 1) * 100
score_20d = change_20d * 0.25
```

#### 9.3.2 资金流向指标（权重30%，最高）
```python
# 使用近5日成交量相对20日均量的变化作为资金流向代理
recent_volume = 近5日成交量均值
avg_volume = 近20日成交量均值
flow_ratio = (recent_volume / avg_volume - 1.0) * 100

# 转换为-10到+10分
money_flow_score = max(-10, min(10, flow_ratio / 2))
score_money = money_flow_score * 0.30
```

**说明：** 实际应用中应使用真实的主力资金净流入数据，当前使用成交量作为代理。

#### 9.3.3 成交量因子
```python
# 成交量相对变化
volume_ratio = 近5日成交量均值 / 近20日成交量均值

# 成交量因子：1.0为中性，1.5为放量，0.8为缩量
volume_factor = (volume_ratio - 1.0) * 50  # 转换为-10到+10分
volume_factor = max(-10, min(10, volume_factor))
score_volume = volume_factor * 0.10
```

#### 9.3.4 长期趋势健康度（过滤器）
```python
# 计算MA60和MA120
ma60 = 近60日收盘价均值
ma120 = 近120日收盘价均值
current_price = 当前收盘价

# 检查是否空头排列
is_bearish = (ma60 < ma120) and (current_price < ma60)

# 计算趋势健康度得分（0-100分）
if current_price > ma60 > ma120:
    health_score = 100.0  # 完美多头排列
elif current_price > ma60 and ma60 > ma120 * 0.95:
    health_score = 70.0   # 接近多头
elif current_price > ma60:
    health_score = 50.0   # 价格在MA60上方
elif not is_bearish:
    health_score = 30.0   # 非空头但较弱
else:
    health_score = 0.0    # 空头排列

# 趋势健康度贡献（0-5分）
score_trend = (health_score / 100.0) * 5.0

# 过滤器：长期空头趋势板块直接过滤
if is_bearish:
    板块被过滤，不进入强势板块列表
```

#### 9.3.5 板块逻辑合理性调整分
```python
# 长期看淡的板块（负向调整）
negative_sectors = {
    '房地产开发': -3.0,  # 房地产政策环境不利
    '房地产服务': -2.5,
    '物业管理': -2.0,
    '建筑装饰': -1.5,
    '建筑材料': -1.0,
}

# 长期看好的板块（正向调整）
positive_sectors = {
    '人工智能': +1.0,
    '新能源': +0.5,
    '半导体': +0.5,
}

# 基础调整分
base_adjustment = 根据板块名称匹配调整分数
```

**说明：** 此调整分可根据市场环境、政策变化动态更新。

### 9.4 综合得分计算

```python
# 综合得分 = 各指标得分之和
strength_score = (
    score_5d +           # 5日涨幅贡献
    score_10d +          # 10日涨幅贡献
    score_20d +          # 20日涨幅贡献
    score_money +        # 资金流向贡献（权重30%）
    score_volume +        # 成交量贡献
    score_trend +         # 趋势健康度贡献
    base_adjustment      # 基础调整分
)
```

### 9.5 板块筛选规则

```python
# 1. 长期趋势过滤器
if 板块长期空头排列:
    直接过滤，不进入候选列表

# 2. 按综合得分排序
板块列表 = 按strength_score降序排序

# 3. 取前N%（如30%）
强势板块 = 板块列表[:前30%]
```

### 9.6 诊断功能：板块强度得分明细表

为了帮助诊断算法判断是否合理，系统提供详细的得分明细表：

| 板块名称 | 综合得分 | 5日涨幅(%) | 5日贡献 | 10日涨幅(%) | 10日贡献 | 20日涨幅(%) | 20日贡献 | 资金流向得分 | 资金贡献 | 成交量因子 | 成交量贡献 | 趋势健康度 | 趋势贡献 | 基础调整 |
|---------|---------|-----------|---------|------------|---------|------------|---------|------------|---------|-----------|-----------|-----------|---------|---------|
| 房地产开发 | 12.68 | +15.2 | +3.04 | +8.5 | +1.28 | +5.3 | +1.33 | -2.5 | -0.75 | +1.2 | +0.12 | 30.0 | +1.5 | -3.0 |

**诊断要点：**
1. **短期脉冲识别**：如果高分主要来自5日涨幅，可能是短期脉冲，需谨慎
2. **资金验证**：如果资金贡献为负或很小，但综合得分高，可能存在偏差
3. **逻辑合理性**：检查基础调整分是否生效（如房地产应为-3.0）
4. **趋势健康度**：趋势健康度低但得分高，可能是反弹而非反转

### 9.7 算法优化历史

**优化前（问题版本）：**
- 5日涨幅权重：50%（过高，容易被短期波动误导）
- 20日涨幅权重：30%
- 成交量权重：20%
- **问题**：房地产板块因短期反弹被误判为强势

**优化后（当前版本）：**
- 5日涨幅权重：20%（降低）
- 10日涨幅权重：15%（新增，平滑波动）
- 20日涨幅权重：25%（略降）
- 资金流向权重：30%（新增，最高权重）
- 成交量权重：10%（降低）
- 趋势健康度：0-5分（新增过滤器）
- 基础调整分：±3分（新增逻辑合理性检查）

### 9.8 参数配置表

| 参数类别 | 参数名称 | 默认值 | 可调整范围 | 说明 |
|---------|---------|--------|-----------|------|
| 涨跌幅权重 | 5日涨幅权重 | 20% | 10%-30% | 短期涨幅权重 |
| 涨跌幅权重 | 10日涨幅权重 | 15% | 10%-25% | 中期涨幅权重 |
| 涨跌幅权重 | 20日涨幅权重 | 25% | 20%-35% | 长期涨幅权重 |
| 资金权重 | 资金流向权重 | 30% | 20%-40% | 资金流向权重（最高） |
| 成交量权重 | 成交量权重 | 10% | 5%-15% | 成交量变化权重 |
| 趋势权重 | 趋势健康度权重 | 5分 | 3-10分 | 长期趋势健康度 |
| 调整参数 | 基础调整分范围 | ±3分 | ±5分 | 板块逻辑合理性调整 |
| 筛选参数 | 强势板块比例 | 30% | 20%-50% | 返回前N%板块 |

### 9.9 使用建议

1. **定期检查明细表**：通过得分明细表诊断算法判断是否合理
2. **动态调整参数**：根据市场环境调整权重配置
3. **更新板块调整分**：根据政策变化、市场环境更新板块基础调整分
4. **交叉验证**：与主流财经软件的板块涨幅排行对比验证
5. **回测验证**：在历史数据上验证算法的有效性

## 十、示例代码框架（Python）

```python
class StockScoringAlgorithm:
    def __init__(self, config):
        """初始化算法参数"""
        self.config = config
        
    def calculate_indicators(self, stock_data):
        """计算所有技术指标"""
        # 实现均线、RSI、MACD、布林带等计算
        pass
        
    def score_indicators(self, indicators):
        """为各指标评分"""
        scores = {
            'buy_score': 0,
            'sell_score': 0
        }
        
        # 各指标评分逻辑
        scores['buy_score'] += self.score_ma(indicators)
        scores['buy_score'] += self.score_rsi(indicators)
        scores['sell_score'] += self.score_macd(indicators)[1]  # 卖出部分
        # ... 其他指标
        
        return scores
    
    def generate_signal(self, scores):
        """生成交易信号"""
        net_score = scores['buy_score'] - scores['sell_score']
        
        # 根据阈值生成信号
        if net_score >= self.config['buy_threshold']:
            signal = 'BUY'
        elif net_score <= self.config['sell_threshold']:
            signal = 'SELL'
        else:
            signal = 'HOLD'
            
        return signal, net_score
    
    def calculate_strength(self, signal, scores):
        """计算信号强度"""
        # 实现强度计算逻辑
        pass

class SectorStrengthAnalyzer:
    """板块强度分析器"""
    
    def get_sector_strength_detailed(self, top_n=30):
        """计算板块强度（详细版）"""
        # 1. 获取板块列表
        # 2. 计算各指标得分
        # 3. 应用长期趋势过滤器
        # 4. 计算综合得分
        # 5. 返回强势板块列表和详细明细表
        pass
    
    def _check_long_term_trend(self, hist_df):
        """检查长期趋势（过滤器）"""
        # 计算MA60、MA120
        # 判断是否空头排列
        # 计算趋势健康度得分
        pass
    
    def _get_sector_base_adjustment(self, sector_name):
        """获取板块基础调整分"""
        # 根据板块名称返回调整分数
        pass
```
