# 评分字段含义说明

## 📊 核心评分字段

### 1. **买入评分 (buy_score)**
**含义**：基于多个技术指标累加的买入信号强度分数

**计算方法**：通过以下技术指标累加得到：

| 指标 | 条件 | 加分 |
|------|------|------|
| **移动平均线 (MA)** | 完整多头排列（价格>MA5>MA10>MA20） | +2分 |
| | 短期多头排列（价格>MA5>MA10） | +1分 |
| **RSI相对强弱指标** | RSI超卖（RSI < 30） | +3分 |
| | RSI处于低位（30 ≤ RSI ≤ 50） | +1分 |
| | RSI底背离（价格创新低，RSI未创新低） | +2分 |
| **MACD指标** | MACD金叉（MACD上穿信号线） | +2分 |
| | MACD柱状图为正 | +1分 |
| | MACD上穿零轴 | +1分 |
| **布林带 (BB)** | 价格触及下轨 | +2分 |
| | 布林带张口且价格上涨 | +1分 |
| **成交量** | 放量上涨（成交量>平均成交量×阈值） | +1分 |
| | 量价背离：下跌但缩量 | +1分 |

**理论最大值**：约18分（所有买入信号同时满足）

---

### 2. **卖出评分 (sell_score)**
**含义**：基于多个技术指标累加的卖出信号强度分数

**计算方法**：通过以下技术指标累加得到：

| 指标 | 条件 | 加分 |
|------|------|------|
| **移动平均线 (MA)** | 完整空头排列（价格<MA5<MA10<MA20） | +2分 |
| | 短期空头排列（价格<MA5<MA10） | +1分 |
| **RSI相对强弱指标** | RSI超买（RSI > 70） | +3分 |
| | RSI处于高位（50 < RSI ≤ 70） | +1分 |
| | RSI顶背离（价格创新高，RSI未创新高） | +2分 |
| **MACD指标** | MACD死叉（MACD下穿信号线） | +2分 |
| | MACD柱状图为负 | +1分 |
| | MACD下穿零轴 | +1分 |
| **布林带 (BB)** | 价格触及上轨 | +2分 |
| | 布林带张口且价格下跌 | +1分 |
| **成交量** | 放量下跌（成交量>平均成交量×阈值） | +1分 |
| | 量价背离：上涨但缩量 | +1分 |

**理论最大值**：约18分（所有卖出信号同时满足）

---

### 3. **净评分 (net_score)**
**含义**：买入评分与卖出评分的差值，反映多空力量对比

**计算公式**：
```
net_score = buy_score - sell_score
```

**解读**：
- **net_score > 0**：买入力量强于卖出力量
- **net_score < 0**：卖出力量强于买入力量
- **net_score = 0**：多空力量均衡

**信号判断阈值**：
- `net_score ≥ 8`：**强烈买入** (STRONG_BUY)
- `net_score ≥ 4`：**买入** (BUY)
- `net_score ≥ 2`：**谨慎买入** (CAUTIOUS_BUY)
- `-2 < net_score < 2`：**持有观望** (HOLD)
- `net_score ≤ -2`：**谨慎卖出** (CAUTIOUS_SELL)
- `net_score ≤ -4`：**卖出** (SELL)
- `net_score ≤ -8`：**强烈卖出** (STRONG_SELL)

---

### 4. **信号强度 (strength)**
**含义**：信号强度的百分比值（0-100%），反映信号的可靠性和强度

**计算公式**（以买入信号为例）：
```python
# 1. 基础强度：买入分数在总分数中的占比
base_strength = (buy_score / total_score) * 100
# 其中 total_score = buy_score + sell_score

# 2. 分数因子：买入分数相对于最大可能分数的占比
max_possible_buy_score = 18
score_factor = min((buy_score / max_possible_buy_score) * 100, 100)

# 3. 综合计算：基础强度占60%，分数因子占40%
strength = base_strength * 0.6 + score_factor * 0.4

# 4. 单日涨幅过大惩罚（规避追高风险）
if 单日涨幅 > 9.5%:
    strength = strength * 0.3  # 降权至30%
elif 单日涨幅 > 7.0%:
    strength = strength * 0.6  # 降权至60%
elif 单日涨幅 > 5.0%:
    strength = strength * 0.8  # 降权至80%
```

**强度等级划分**：
- **≥ 80%**：极强
- **≥ 70%**：强
- **≥ 60%**：中等
- **≥ 50%**：弱
- **≥ 40%**：很弱
- **< 40%**：极弱

**设计理念**：
- **基础强度 (60%权重)**：反映买入信号在多空对比中的相对优势
- **分数因子 (40%权重)**：反映买入信号的绝对强度
- **涨幅惩罚**：单日涨幅过大时降低强度，规避追高风险

---

## 📈 使用建议

### 如何解读这些评分？

1. **买入评分 vs 卖出评分**
   - 如果 `buy_score` 远大于 `sell_score`，说明技术面偏向买入
   - 如果 `sell_score` 远大于 `buy_score`，说明技术面偏向卖出

2. **净评分**
   - `net_score ≥ 4`：可以考虑买入
   - `net_score ≥ 8`：强烈买入信号
   - `net_score` 接近0：多空均衡，建议观望

3. **信号强度**
   - `strength ≥ 70%`：信号可靠性高，可以重点关注
   - `strength < 50%`：信号较弱，需要谨慎
   - 注意：即使 `net_score` 较高，如果 `strength` 较低，也要谨慎操作

4. **综合判断**
   - **高净评分 + 高强度**：最佳买入时机
   - **高净评分 + 低强度**：可能是追高，需要谨慎
   - **低净评分**：不建议操作，即使强度较高

---

## 🔍 示例解读

假设某只股票的评分如下：
- `buy_score = 8`
- `sell_score = 2`
- `net_score = 6`
- `strength = 65%`

**解读**：
- 买入信号明显强于卖出信号（8分 vs 2分）
- 净评分为6分，属于"买入"级别（≥4且<8）
- 信号强度为65%，属于"中等"强度
- **结论**：这是一个中等强度的买入信号，可以考虑买入，但需要结合其他因素（如板块、市场环境等）综合判断

---

---

### 5. **信号 (signal)**
**含义**：基于净评分生成的详细信号类型

**计算逻辑**：
```python
if net_score >= 8:
    signal = "STRONG_BUY"  # 强烈买入
elif net_score >= 4:
    signal = "BUY"  # 买入
elif net_score >= 2:
    signal = "CAUTIOUS_BUY"  # 谨慎买入
elif -2 < net_score < 2:
    signal = "HOLD"  # 持有观望
elif net_score <= -2:
    signal = "CAUTIOUS_SELL"  # 谨慎卖出
elif net_score <= -4:
    signal = "SELL"  # 卖出
elif net_score <= -8:
    signal = "STRONG_SELL"  # 强烈卖出
```

---

### 6. **信号类型 (signal_type)**
**含义**：信号的简化分类（BUY/SELL/HOLD）

**计算逻辑**：
```python
if net_score >= 2:
    signal_type = "BUY"
elif net_score <= -2:
    signal_type = "SELL"
else:
    signal_type = "HOLD"
```

---

### 7. **强度等级 (strength_level)**
**含义**：信号强度的文字描述

**计算逻辑**：
```python
if signal_type in ['BUY', 'SELL']:
    if strength >= 80:
        strength_level = "极强"
    elif strength >= 70:
        strength_level = "强"
    elif strength >= 60:
        strength_level = "中等"
    elif strength >= 50:
        strength_level = "弱"
    elif strength >= 40:
        strength_level = "很弱"
    else:
        strength_level = "极弱"
else:
    strength_level = "无"
```

---

### 8. **原因 (reason)**
**含义**：触发信号的主要原因说明

**计算逻辑**：
- 收集所有触发的技术指标信号（最多3个）
- 用 `" | "` 分隔符连接
- 如果单日涨幅过大，会添加警告信息

**示例**：
- `"RSI超卖 | MACD金叉 | 价格触及布林带下轨"`
- `"⚠️ 单日涨幅较大(7.5%)，注意追高风险 | MACD金叉 | 放量上涨"`

---

## 🎯 预测评分字段

### 9. **预测评分 (predictive_score)**
**含义**：综合考虑板块共识、价格动量、市场趋势、资金热度等因素的综合评分（0-100分）

**计算逻辑**：

#### 步骤1：计算各模块评分（0-100分）
```python
# 1. 板块共识度评分（权重35%）
sector_score = sector_consensus * 100
# sector_consensus: 板块内其他股票的买入信号一致性（0-1）

# 2. 价格动量评分（权重30%）
price_acceleration = stock_factors.get('price_acceleration', 0)
price_score = 50 + 50 * tanh(price_acceleration / 30)  # 映射到0-100

# 3. 市场趋势评分（权重20%）
market_score = market_trend_score * 100
# market_trend_score: 大盘趋势评分（0-1）

# 4. 资金热度评分（权重15%）
volume_quality = stock_factors.get('price_volume_quality', 1)
if volume_quality > 0:
    volume_score = min(100, max(0, 20 * log1p(volume_quality - 1) * 10))
else:
    volume_score = 0
```

#### 步骤2：加权计算综合评分
```python
total_score = (
    sector_score * 0.35 +
    price_score * 0.30 +
    market_score * 0.20 +
    volume_score * 0.15
)
```

#### 步骤3：风险调整（降权规则）
```python
# 规则A：原信号为卖出，大幅降权
if signal_type == 'SELL' or signal in ['STRONG_SELL', 'SELL', 'CAUTIOUS_SELL']:
    total_score *= 0.3

# 规则B：单日涨幅过大，规避追高风险
if daily_change_pct > 9.5%:
    total_score *= 0.3  # 大幅降权
elif daily_change_pct > 7.0%:
    total_score *= 0.6  # 中等降权
elif daily_change_pct > 5.0%:
    total_score *= 0.8  # 轻微降权

# 规则C：波动率过高，追求稳健
volatility_ratio = stock_factors.get('volatility_ratio', 0)
if volatility_ratio > 3.0:
    total_score *= 0.7  # 高波动降权
elif volatility_ratio > 2.5:
    total_score *= 0.85  # 中高波动降权

# 确保分数在0-100范围内
total_score = max(0, min(100, total_score))
```

**最终值**：`predictive_score = round(total_score, 1)`

---

### 10. **预测推荐 (predictive_recommendation)**
**含义**：基于预测评分生成的操作建议

**计算逻辑**：
```python
if predictive_score >= 75:
    predictive_recommendation = "强力买入"
elif predictive_score >= 60:
    predictive_recommendation = "买入"
elif predictive_score >= 50:
    predictive_recommendation = "谨慎买入"
elif predictive_score >= 40:
    predictive_recommendation = "观望"
else:
    predictive_recommendation = "规避"
```

**说明**：即使技术面信号是BUY，如果预测评分较低（如单日涨幅过大、波动率过高、市场趋势差等），预测推荐也可能是"规避"或"观望"。

---

### 11. **预测止损 (predictive_stop_loss)**
**含义**：基于预测因子和技术信号计算的动态止损位（价格）

**计算逻辑**：

#### 步骤1：确定基础止损位
```python
# 优先使用技术面信号中的止损位
suggested_stop_loss = signal.get('suggested_stop_loss', 0)
if suggested_stop_loss > 0:
    base_stop_loss = suggested_stop_loss
else:
    base_stop_loss = current_price * 0.95  # 默认-5%止损
```

#### 步骤2：风险调整
```python
risk_adjustment = 1.0

# 市场趋势差时，止损更紧
if market_trend_score < 0.4:
    risk_adjustment *= 0.95  # 市场差，止损收紧5%

# 波动率大时，止损更紧
volatility_ratio = factors.get('volatility_ratio', 2.0)
if volatility_ratio > 3.0:
    risk_adjustment *= 0.93  # 高波动，止损收紧7%
elif volatility_ratio > 2.5:
    risk_adjustment *= 0.96  # 中高波动，止损收紧4%

adjusted_stop_loss = base_stop_loss * risk_adjustment
```

#### 步骤3：限制止损范围
```python
# 确保止损位不超过-8%（防止止损过远）
max_loss_stop = current_price * 0.92
final_stop_loss = min(adjusted_stop_loss, max_loss_stop)
```

**最终值**：`predictive_stop_loss = round(final_stop_loss, 2)`

---

### 12. **止损类型 (predictive_stop_loss_type)**
**含义**：止损位的类型说明

**计算逻辑**：
```python
stop_loss_type = "技术止损"

if market_trend_score < 0.4:
    stop_loss_type += " + 市场风险调整"

if volatility_ratio > 2.5:
    stop_loss_type += " + 波动率调整"
```

**示例**：
- `"技术止损"`
- `"技术止损 + 市场风险调整"`
- `"技术止损 + 波动率调整"`
- `"技术止损 + 市场风险调整 + 波动率调整"`

---

### 13. **时间止损 (predictive_time_stop)**
**含义**：时间止损建议

**固定值**：`"3日不涨即平仓"`

**说明**：如果买入后3个交易日内没有明显上涨，建议平仓止损。

---

### 14. **预测仓位 (predictive_position)**
**含义**：基于预测评分和波动率建议的仓位

**计算逻辑**：
```python
volatility_ratio = factors.get('volatility_ratio', 2.0)

if predictive_score >= 70 and volatility_ratio < 2:
    predictive_position = "中等仓位 (7-10%)"
elif predictive_score >= 60:
    predictive_position = "轻仓 (3-5%)"
elif predictive_score >= 50:
    predictive_position = "观察仓 (1-2%)"
else:
    predictive_position = "观察仓 (1-2%) 或不参与"
```

---

### 15. **原始信号 (original_signal)**
**含义**：技术面生成的原始信号（与signal字段相同）

**说明**：用于对比技术面信号和预测推荐的差异。

---

### 16. **原始原因 (original_reason)**
**含义**：技术面信号的原因（与reason字段相同）

**说明**：用于了解技术面信号的触发原因。

---

## 🛡️ 风险控制字段

### 17. **建议止损 (suggested_stop_loss)**
**含义**：基于技术分析计算的止损位（价格）

**计算逻辑**（买入信号）：

#### 方法1：基于近期低点
```python
recent_low_20d = df['Low'].iloc[-20:].min()  # 最近20日最低价
```

#### 方法2：基于MA20支撑位
```python
ma20_support = latest['MA20']  # MA20均线作为支撑
```

#### 方法3：基于ATR（平均真实波幅）
```python
# 计算ATR（最近14日）
high_low = df['High'] - df['Low']
high_close = abs(df['High'] - df['Close'].shift())
low_close = abs(df['Low'] - df['Close'].shift())
true_range = max(high_low, high_close, low_close)
atr = true_range.iloc[-14:].mean()
atr_stop_loss = current_price - (atr * 2)  # 2倍ATR止损
```

#### 方法4：固定百分比止损
```python
fixed_stop_loss = current_price * 0.95  # -5%止损
```

#### 最终止损位
```python
# 取最保守的止损位（最高的止损价，即损失最小）
stop_loss = max(recent_low_20d, ma20_support, atr_stop_loss, fixed_stop_loss)

# 确保止损位不超过当前价格的-8%
max_loss_stop = current_price * 0.92
stop_loss = min(stop_loss, max_loss_stop)
```

**数据不足时**：如果数据少于20日，使用固定百分比止损 `current_price * 0.95`

---

### 18. **仓位建议 (position_suggestion)**
**含义**：基于信号强度和波动率建议的仓位

**计算逻辑**：

#### 步骤1：计算波动率
```python
# 基于ATR计算波动率
if len(df) >= 14:
    atr = ...  # 计算ATR（同上）
    volatility_ratio = (atr / current_price) * 100
else:
    volatility_ratio = 3.0  # 默认中等波动率
```

#### 步骤2：根据信号强度和波动率确定仓位
```python
if strength >= 80 and volatility_ratio < 2.0:
    position_suggestion = "中等仓位 (7-10%)"
elif strength >= 70 and volatility_ratio < 2.5:
    position_suggestion = "轻仓 (3-5%)"
elif strength >= 60 and volatility_ratio < 3.0:
    position_suggestion = "观察仓 (1-2%)"
elif strength >= 50:
    if volatility_ratio < 3.5:
        position_suggestion = "观察仓 (1-2%)"
    else:
        position_suggestion = "不参与（波动率过高）"
else:
    position_suggestion = "不参与（信号强度不足）"
```

**数据不足时**：
```python
if strength >= 70:
    return "轻仓 (3-5%)"
elif strength >= 50:
    return "观察仓 (1-2%)"
else:
    return "不参与"
```

---

## 📈 收益分析字段

### 19. **买入价 (buy_price)**
**含义**：根据买入时机设置确定的价格

**计算逻辑**：
```python
if buy_timing == "当天买入":
    # 买入价为所选日期当天的收盘价
    buy_price = 所选日期当天的收盘价
else:  # 隔天买入
    # 买入价为所选日期后第一个交易日的开盘价
    buy_price = 所选日期后第一个交易日的开盘价
    # 如果开盘价不可用，使用收盘价
```

---

### 20. **T+N最高价 (t1_price, t2_price, ...)**
**含义**：买入后第N个交易日的最高价

**计算逻辑**：
```python
# 当天买入：T+1为推荐日期后第1个交易日，T+2为第2个交易日，以此类推
# 隔天买入：T+1为推荐日期后第2个交易日，T+2为第3个交易日，以此类推

tN_price = 第N个交易日的最高价
```

---

### 21. **T+N收盘 (t1_close, t2_close, ...)**
**含义**：买入后第N个交易日的收盘价

**计算逻辑**：
```python
tN_close = 第N个交易日的收盘价
```

---

### 22. **T+N收益率(%) (t1_return, t2_return, ...)**
**含义**：买入后第N个交易日的收益率（基于最高价计算）

**计算公式**：
```python
tN_return = ((tN_price - buy_price) / buy_price) * 100
```

**说明**：
- 使用最高价计算收益率，反映最佳卖出时机的收益
- 正值表示盈利，负值表示亏损
- 单位为百分比（%）

---

### 23. **状态 (status)**
**含义**：数据获取和分析的状态

**可能值**：
- `"成功"`：数据获取和分析成功
- `"数据获取失败"`：无法获取股票历史数据
- `"无法获取所选日期数据"`：所选日期不是交易日或数据不可用
- `"无后续交易日数据"`：没有后续交易日的数据
- `"交易日数据不足（需要N个，实际M个）"`：后续交易日数据不足
- `"无法获取当天收盘价"`：当天买入时无法获取收盘价
- `"无法获取隔天开盘价"`：隔天买入时无法获取开盘价
- `"错误: [错误信息]"`：其他错误

---

## 📈 使用建议

### 如何解读这些评分？

1. **买入评分 vs 卖出评分**
   - 如果 `buy_score` 远大于 `sell_score`，说明技术面偏向买入
   - 如果 `sell_score` 远大于 `buy_score`，说明技术面偏向卖出

2. **净评分**
   - `net_score ≥ 4`：可以考虑买入
   - `net_score ≥ 8`：强烈买入信号
   - `net_score` 接近0：多空均衡，建议观望

3. **信号强度**
   - `strength ≥ 70%`：信号可靠性高，可以重点关注
   - `strength < 50%`：信号较弱，需要谨慎
   - 注意：即使 `net_score` 较高，如果 `strength` 较低，也要谨慎操作

4. **预测评分 vs 技术面信号**
   - **技术面信号 (signal)**：仅基于技术指标，不考虑市场环境
   - **预测推荐 (predictive_recommendation)**：综合考虑板块、市场、风险等因素
   - 如果技术面是BUY但预测推荐是"规避"，说明存在风险因素（如涨幅过大、波动率高等）

5. **综合判断**
   - **高净评分 + 高强度 + 高预测评分**：最佳买入时机
   - **高净评分 + 低强度**：可能是追高，需要谨慎
   - **低净评分**：不建议操作，即使强度较高
   - **技术面BUY但预测推荐"规避"**：需要特别谨慎，可能存在追高风险

---

## 🔍 示例解读

假设某只股票的评分如下：
- `buy_score = 8`
- `sell_score = 2`
- `net_score = 6`
- `strength = 65%`
- `signal = "BUY"`
- `predictive_score = 35`
- `predictive_recommendation = "规避"`

**解读**：
- 买入信号明显强于卖出信号（8分 vs 2分）
- 净评分为6分，属于"买入"级别（≥4且<8）
- 信号强度为65%，属于"中等"强度
- **但预测评分只有35分，预测推荐为"规避"**
- **结论**：虽然技术面显示买入信号，但由于预测评分较低（可能是单日涨幅过大、波动率过高或市场趋势差），建议规避或观望

---

## ⚠️ 注意事项

1. **这些评分仅基于技术指标**，不包含基本面、消息面等因素
2. **单日涨幅过大时会自动降权**，避免追高风险
3. **建议结合预测评分 (predictive_score)** 一起使用，预测评分考虑了板块共识、市场趋势等因素
4. **不同周期（1mo, 3mo, 6mo, 1y）的阈值会自适应调整**，以适应不同时间尺度的分析
5. **止损位和仓位建议仅供参考**，实际交易中应根据个人风险承受能力调整
6. **收益分析基于历史数据**，不代表未来表现，仅供参考
